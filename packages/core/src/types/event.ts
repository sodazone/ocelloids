import type { BlockNumber, EventRecord } from '@polkadot/types/interfaces';
import type { AnyJson } from '@polkadot/types-codec/types';
import { Compact, GenericEvent } from '@polkadot/types';

import { EventBlockContext, EventRecordWithId, EventWithId } from './interfaces.js';

/**
 * A subclass of GenericEvent that includes identifier information.
 */
export class GenericEventWithId extends GenericEvent
  implements EventWithId {
  blockNumber: Compact<BlockNumber>;
  blockPos: number;
  extrinsicPos: number;
  extrinsicId: string;

  constructor(
    // TODO extract param object for positions...
    value: GenericEvent,
    {
      blockNumber,
      blockPosition: blockPos,
      extrinsicPosition: extrinsicPos,
      extrinsicId
    }: EventBlockContext
  ) {
    super(value.registry, value.toU8a());
    this.blockNumber = blockNumber;
    this.blockPos = blockPos;
    this.extrinsicPos = extrinsicPos;
    this.extrinsicId = extrinsicId;
  }

  /**
   * Returns the unique identifier of the event.
   * The identifier is generated by combining the extrinsic ID and the position of the event within the block.
   * The identifier follows the format `<block number>-<tx-position>-<event-position>`, where:
   * - `<block number>` is the number of the block containing the event.
   * - `<tx-position>` is the positional index of the extrinsic within the block, starting from 0.
   * - `<event-position>` is the positional index of the event within the extrinsic, starting from 0.
   */
  get eventId() {
    return `${this.blockNumber.toString()}-${this.blockPos}`;
  }

  /**
   * Returns the JSON representation of the extrinsic with the added extrinsicId, blockNumber, and position properties.
   */
  toHuman(isExpanded?: boolean | undefined): Record<string, AnyJson> {
    return {
      eventId: this.eventId,
      extrinsicId: this.extrinsicId,
      extrinsicPos: this.extrinsicPos,
      blockNumber: this.blockNumber.toHuman(),
      blockPos: this.blockPos,
      ...(super.toHuman(isExpanded) as any)
    };
  }
}

/**
 * Enhances a transaction object with identifier information by wrapping the extrinsic with the GenericExtrinsicWithId class.
 * @param blockNumber The compact block number of the transaction.
 * @param position The position of the transaction within the block.
 * @param tx The transaction object to enhance.
 * @returns The enhanced transaction object with identifier information.
 */
export function enhanceEventRecordWithId(
  blockContext: EventBlockContext,
  record: EventRecord
) : EventRecordWithId {
  (record as unknown as any).event = new GenericEventWithId(
    record.event, blockContext
  );
  return record as EventRecordWithId;
}